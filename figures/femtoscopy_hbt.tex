% femtoscopy_hbt.tex
%
% Femtoscopy (HBT correlations) visualization - REFACTORED for clarity
% Clean 2x2 layout with generous spacing and minimal annotations
%
% DATA CLASSIFICATION:
%   PHYSICS: Bose-Einstein correlation functions
%   Precomputed data from: data/figure_curves/hbt_*.dat
%
% REFACTORED: Uses precomputed data

\documentclass[border=5mm]{standalone}
\usepackage{pgfplots}
\usepackage{tikz}
\usepackage{amsmath}
\pgfplotsset{compat=1.18}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{calc}

% ACCESSIBLE COLOR SCHEME
\input{accessible_colors.tex}

\begin{document}
\begin{tikzpicture}

% ============================================================================
% Panel (a): Correlation function C(q) - TOP LEFT (precomputed)
% ============================================================================
\begin{axis}[
    name=panelA,
    at={(0,0)},
    title={\large\textbf{(a) Two-Particle Correlation Function}},
    xlabel={Relative momentum $q_{\mathrm{inv}}$ (GeV/$c$)},
    ylabel={$C(q_{\mathrm{inv}})$},
    xmin=0, xmax=0.3,
    ymin=0.8, ymax=2.1,
    width=9.5cm,
    height=7.5cm,
    legend pos=north east,
    legend style={font=\small, fill=white, fill opacity=0.95},
    grid=major,
    grid style={thin, draw=gridcolor!50},
    tick label style={font=\small},
    label style={font=\normalsize},
]

% Reference line at C(q) = 1 (no correlation)
\addplot[textmid, densely dashed, thin, domain=0:0.3] {1};
\node[anchor=south west, font=\small, color=textmid] at (axis cs:0.2, 1.02) {No correlation};

% Pb-Pb central - strong correlation (large source) - precomputed
\addplot[PbPbcolor, ultra thick, solid, mark=square*, mark repeat=12, mark size=2pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_corr_PbPb.dat};
\addlegendentry{Pb--Pb 0--5\%}

% O-O central - moderate correlation - precomputed
\addplot[OOcolor, ultra thick, dashed, mark=o, mark repeat=12, mark size=2pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_corr_OO.dat};
\addlegendentry{O--O 0--10\%}

% pp high-mult - weak correlation (small source) - precomputed
\addplot[ppcolor, thick, dotted, mark=triangle*, mark repeat=12, mark size=2pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_corr_pp.dat};
\addlegendentry{pp high-mult}

% Minimal annotation
\node[correlcolor, font=\small, anchor=west, align=left]
    at (axis cs:0.05, 1.9) {Bose--Einstein\\enhancement};
\draw[correlcolor, -{Stealth[length=2mm]}, thick]
    (axis cs:0.045, 1.85) -- (axis cs:0.01, 1.7);

\end{axis}

% ============================================================================
% Panel (b): HBT radii vs multiplicity - TOP RIGHT
% ============================================================================
\begin{axis}[
    name=panelB,
    at={(panelA.east)},
    anchor=west,
    xshift=2.2cm,
    title={\large\textbf{(b) HBT Radii vs. Multiplicity}},
    xlabel={$\langle dN_{\mathrm{ch}}/d\eta \rangle$},
    ylabel={HBT Radius (fm)},
    xmode=log,
    xmin=5, xmax=2500,
    ymin=0, ymax=8,
    width=9.5cm,
    height=7.5cm,
    legend pos=north west,
    legend style={font=\small, fill=white, fill opacity=0.95},
    grid=major,
    grid style={thin, draw=gridcolor!50},
    tick label style={font=\small},
    label style={font=\normalsize},
]

% R_out (includes emission duration effect)
\addplot[Routcolor, ultra thick, solid, mark=square*, mark size=3pt]
    coordinates {(8, 1.2) (15, 1.5) (25, 1.8) (35, 2.2) (150, 3.2) (250, 3.8) (350, 4.3) (1600, 5.8)};
\addlegendentry{$R_{\mathrm{out}}$}

% R_side (pure geometry)
\addplot[Rsidecolor, ultra thick, dashed, mark=o, mark size=3pt]
    coordinates {(8, 1.0) (15, 1.3) (25, 1.6) (35, 2.0) (150, 2.8) (250, 3.3) (350, 3.8) (1600, 4.8)};
\addlegendentry{$R_{\mathrm{side}}$}

% R_long (longitudinal extent)
\addplot[Rlongcolor, ultra thick, dotted, mark=triangle*, mark size=3pt]
    coordinates {(8, 1.3) (15, 1.6) (25, 2.0) (35, 2.4) (150, 3.5) (250, 4.2) (350, 4.9) (1600, 6.5)};
\addlegendentry{$R_{\mathrm{long}}$}

% System labels (minimal)
\node[ppcolor, font=\footnotesize] at (axis cs:8, 0.5) {pp};
\node[pPbcolor, font=\footnotesize] at (axis cs:35, 0.5) {p--Pb};
\node[OOcolor, font=\footnotesize] at (axis cs:150, 0.5) {O--O};
\node[PbPbcolor, font=\footnotesize] at (axis cs:1600, 0.5) {Pb--Pb};

% Scaling law annotation (single line)
\node[textmid, font=\small, anchor=north east] at (axis cs:2000, 7.5) {$R \propto (dN_{\mathrm{ch}}/d\eta)^{1/3}$};

\end{axis}

% ============================================================================
% Panel (c): R_out/R_side ratio vs centrality - BOTTOM LEFT (precomputed)
% ============================================================================
\begin{axis}[
    name=panelC,
    at={(panelA.south)},
    anchor=north,
    yshift=-1.8cm,
    title={\large\textbf{(c) Emission Duration: $R_{\mathrm{out}}/R_{\mathrm{side}}$}},
    xlabel={Centrality (\%)},
    ylabel={$R_{\mathrm{out}}/R_{\mathrm{side}}$},
    xmin=0, xmax=80,
    ymin=0.95, ymax=1.35,
    x dir=reverse,
    width=9.5cm,
    height=7.5cm,
    legend pos=north east,
    legend style={font=\small, fill=white, fill opacity=0.95},
    grid=major,
    grid style={thin, draw=gridcolor!50},
    tick label style={font=\small},
    label style={font=\normalsize},
]

% Reference line at ratio = 1
\addplot[textmid, densely dashed, thin, domain=0:80] {1};
\node[anchor=north west, font=\small, color=textmid] at (axis cs:5, 0.99) {No duration effect};

% Pb-Pb - precomputed
\addplot[PbPbcolor, ultra thick, solid, mark=square*, mark size=2.5pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_ratio_PbPb.dat};
\addlegendentry{Pb--Pb}

% O-O - precomputed
\addplot[OOcolor, ultra thick, dashed, mark=o, mark size=2.5pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_ratio_OO.dat};
\addlegendentry{O--O}

% p-Pb - precomputed
\addplot[pPbcolor, thick, dotted, mark=triangle*, mark size=2.5pt]
    table [x index=0, y index=1] {data/figure_curves/hbt_ratio_pPb.dat};
\addlegendentry{p--Pb}

% Duration annotation
\node[PbPbcolor!80!black, font=\small, anchor=south west] at (axis cs:50, 1.25) {$\Delta\tau \approx 2$--3 fm/$c$};

\end{axis}

% ============================================================================
% Panel (d): Homogeneity region schematic - BOTTOM RIGHT (LARGER)
% ============================================================================
\begin{scope}[shift={($(panelC.east) + (2.2cm, 0)$)}]
    % Scale for 9.5cm width equivalent
    \def\sc{1.0}

    % Title
    \node[font=\large\bfseries, anchor=south] at (0, 3.8*\sc) {(d) Spacetime Homogeneity};

    % Axis frame
    \draw[thick, -] (-4.2*\sc, -3.5*\sc) rectangle (4.2*\sc, 3.5*\sc);

    % Axis lines
    \draw[-{Stealth[length=3mm]}, thick] (-4*\sc, 0) -- (4*\sc, 0);
    \draw[-{Stealth[length=3mm]}, thick] (0, -3.3*\sc) -- (0, 3.3*\sc);

    % Axis labels
    \node[font=\normalsize, anchor=north] at (3.8*\sc, -0.2) {$x$ (fm)};
    \node[font=\normalsize, anchor=east] at (-0.2, 3.1*\sc) {$t$ (fm/$c$)};

    % Light cones
    \draw[textmid!60, dashed, thick] (-3*\sc, -3*\sc) -- (0, 0) -- (3*\sc, 3*\sc);
    \draw[textmid!60, dashed, thick] (3*\sc, -3*\sc) -- (0, 0) -- (-3*\sc, 3*\sc);

    % Pb-Pb: Large homogeneity region
    \fill[PbPbcolor!15] (0, 0) ellipse [x radius=3.2*\sc, y radius=2.8*\sc];
    \draw[PbPbcolor, ultra thick] (0, 0) ellipse [x radius=3.2*\sc, y radius=2.8*\sc];
    \node[PbPbcolor, font=\normalsize\bfseries, anchor=south west] at (2.0*\sc, 2.0*\sc) {Pb--Pb};
    \node[PbPbcolor, font=\small, anchor=north west] at (2.5*\sc, -2.0*\sc) {$R \sim 5$ fm};

    % O-O: Intermediate
    \fill[OOcolor!25] (0, 0) ellipse [x radius=1.6*\sc, y radius=1.4*\sc];
    \draw[OOcolor, ultra thick, dashed] (0, 0) ellipse [x radius=1.6*\sc, y radius=1.4*\sc];
    \node[OOcolor, font=\normalsize\bfseries, anchor=south west] at (1.0*\sc, 1.0*\sc) {O--O};
    \node[OOcolor, font=\small, anchor=north west] at (1.2*\sc, -0.8*\sc) {$R \sim 2.5$ fm};

    % pp: Small
    \fill[ppcolor!30] (0, 0) ellipse [x radius=0.7*\sc, y radius=0.6*\sc];
    \draw[ppcolor, thick, dotted] (0, 0) ellipse [x radius=0.7*\sc, y radius=0.6*\sc];
    \node[ppcolor, font=\small\bfseries, anchor=west] at (0.8*\sc, 0) {pp};

    % Volume scaling annotation (bottom)
    \node[textmid, font=\small, anchor=north] at (0, -3.3*\sc) {$V_{\mathrm{hom}} \propto R^3 \propto N_{\mathrm{ch}}$};

\end{scope}

\end{tikzpicture}
\end{document}
