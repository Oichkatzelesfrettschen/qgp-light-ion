name: Comprehensive CI Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Code Quality - Linting & Formatting
  # ===========================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pylint bandit[toml] vulture radon interrogate

      - name: Ruff - Format check
        run: |
          echo "::group::Ruff Format Check"
          ruff format --check .
          echo "::endgroup::"

      - name: Ruff - Lint
        run: |
          echo "::group::Ruff Lint"
          ruff check . --output-format=github
          echo "::endgroup::"

      - name: MyPy - Type check
        run: |
          echo "::group::MyPy Type Checking"
          mypy src tests --ignore-missing-imports --check-untyped-defs || true
          echo "::endgroup::"

      - name: Pylint - Comprehensive lint
        run: |
          echo "::group::Pylint Analysis"
          pylint src tests --exit-zero --score=yes --output-format=colorized
          echo "::endgroup::"

      - name: Radon - Complexity check
        run: |
          echo "::group::Radon Complexity Metrics"
          radon cc src -s -n C
          radon mi src -s -n B
          echo "::endgroup::"

      - name: Interrogate - Docstring coverage
        run: |
          echo "::group::Docstring Coverage"
          interrogate src -vv --fail-under 60 || true
          echo "::endgroup::"

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety pip-audit

      - name: Bandit - Security vulnerability scan
        run: |
          echo "::group::Bandit Security Scan"
          bandit -r src -c pyproject.toml -f json -o bandit-report.json || true
          bandit -r src -c pyproject.toml || true
          echo "::endgroup::"

      - name: Safety - Dependency vulnerability check
        run: |
          echo "::group::Safety Dependency Check"
          safety check --json || true
          echo "::endgroup::"

      - name: Pip-audit - PyPI advisory check
        run: |
          echo "::group::Pip-Audit"
          pip-audit || true
          echo "::endgroup::"

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  # ===========================================================================
  # Testing - Multi-platform & Multi-version
  # ===========================================================================
  test:
    name: Test (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest -v --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing
        env:
          PYTEST_TIMEOUT: 300

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests-${{ matrix.os }}-py${{ matrix.python-version }}
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

  # ===========================================================================
  # Build Validation
  # ===========================================================================
  build:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [lint, security, test]  # Run after other checks pass
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            latexmk \
            pandoc

      - name: Verify environment
        run: |
          python3 --version
          pandoc --version
          pdflatex --version
          latexmk --version

      - name: Generate physics data
        run: |
          make data
        timeout-minutes: 10

      - name: Verify data generation
        run: |
          make verify-data

      - name: Run data validation tests
        run: |
          make test-quick

      - name: Compile figures (parallel)
        run: |
          make -j4 figures
        timeout-minutes: 15

      - name: Lint LaTeX
        run: |
          make lint-latex || true

      - name: Build PDF (strict mode)
        run: |
          make strict
        timeout-minutes: 20

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: qgp-light-ion-pdf
          path: build/qgp-light-ion.pdf
          retention-days: 90

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build/*.log
          retention-days: 30

  # ===========================================================================
  # Documentation Build
  # ===========================================================================
  docs:
    name: Documentation Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      - name: Build documentation
        run: |
          # TODO: Add Sphinx documentation build
          echo "Documentation build placeholder"
          echo "Will add: cd docs && make html"

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, security, test, build, docs]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.lint.result == 'failure' ||
          needs.security.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.docs.result == 'failure'
        run: exit 1
